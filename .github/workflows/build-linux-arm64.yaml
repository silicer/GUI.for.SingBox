name: Build Linux ARM64 AppImage (Legacy Stable Fix)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  Build-Frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: "latest"
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml
      - run: |
          cd frontend
          pnpm install --frozen-lockfile
          pnpm build-only
      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

  Build-AppImage-Debian10:
    needs: Build-Frontend
    runs-on: ubuntu-24.04-arm
    container:
      image: debian:10
      options: --user root
    env:
      APP_NAME: GUI.for.SingBox
    steps:
      - uses: actions/checkout@v4

      - name: Fix Debian 10 Sources (Archive + Backports)
        run: |
          echo "deb http://archive.debian.org/debian buster main" > /etc/apt/sources.list
          echo "deb http://archive.debian.org/debian-security buster/updates main" >> /etc/apt/sources.list
          echo "deb http://archive.debian.org/debian buster-backports main" >> /etc/apt/sources.list
          echo "Acquire::Check-Valid-Until \"false\";" > /etc/apt/apt.conf.d/99no-check-valid-until
          
          apt-get update
          apt-get install -y -t buster-backports libwebkit2gtk-4.0-dev || apt-get install -y libwebkit2gtk-4.0-dev
          
          apt-get install -y wget curl git build-essential pkg-config \
          libgtk-3-dev libayatana-appindicator3-dev \
          librsvg2-dev file desktop-file-utils fuse libfuse2 zip

      - name: Install Go (v1.21.13 - Legacy Stable)
        run: |
          # 回退到 Go 1.21.13，这个版本没有 1.22+ 那种激进的 embed 优化，兼容性最好
          wget https://go.dev/dl/go1.21.13.linux-arm64.tar.gz
          tar -C /usr/local -xzf go1.21.13.linux-arm64.tar.gz
          echo "/usr/local/go/bin" >> $GITHUB_PATH

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Build Binary (The "Magic" Flags)
        run: |
          export PATH=$PATH:/usr/local/go/bin
          export CGO_ENABLED=1
          
          # --- 核心修复参数 ---
          # 1. 禁用 Go 1.22+ 引入的 CGO 重写器（如果是用 1.22+ 编译）
          export CGO_REWRITER=0 
          # 2. 限制内存 GC，防止在容器内因内存波动导致编译器 internal error
          export GOGC=50
          # 3. 强制使用本地缓存目录
          export GOCACHE=/tmp/gocache
          # -------------------

          echo "==> Installing Wails CLI v2.8.2..."
          go install github.com/wailsapp/wails/v2/cmd/wails@v2.8.2
          W_BIN=$(go env GOPATH)/bin/wails
          
          echo "==> Adjusting go.mod..."
          sed -i 's/github.com\/wailsapp\/wails\/v2 v2.11.0/github.com\/wailsapp\/wails\/v2 v2.8.2/g' go.mod
          go mod edit -dropreplace github.com/wailsapp/wails/v2
          
          # 彻底清理并重新拉取依赖
          rm -rf build/bin
          go clean -cache -modcache
          go mod tidy

          echo "==> Executing Build..."
          # 使用原生 go build 进行最终链接尝试
          $W_BIN build -m -s -trimpath -skipbindings -tags webkit2_40 -o $APP_NAME

      - name: Package AppImage
        run: |
          wget -O linuxdeploy https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
          chmod +x linuxdeploy
          ./linuxdeploy --appimage-extract
          LD_BIN=$(pwd)/squashfs-root/usr/bin/linuxdeploy
          
          mkdir -p AppDir
          cp build/bin/$APP_NAME AppDir/
          [ -f "build/appicon.png" ] && cp build/appicon.png AppDir/appicon.png || touch AppDir/appicon.png
          
          cat > AppDir/gui-for-singbox.desktop <<EOF
          [Desktop Entry]
          Name=GUI.for.SingBox
          Exec=$APP_NAME
          Icon=appicon
          Type=Application
          Categories=Utility;
          EOF

          $LD_BIN --appdir AppDir \
            -e build/bin/$APP_NAME \
            -i AppDir/appicon.png \
            -d AppDir/gui-for-singbox.desktop \
            --output appimage

          mv *.AppImage $APP_NAME-Debian10-ARM64.AppImage

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: GUI-SingBox-Debian10-ARM64
          path: ./*.AppImage