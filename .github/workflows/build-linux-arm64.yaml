name: Build Linux ARM64 (Debian 10 Clean Room)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  Build-Frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: "latest"
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml
      - run: |
          cd frontend
          pnpm install --frozen-lockfile
          pnpm build-only
      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

  Build-AppImage-Debian10:
    needs: Build-Frontend
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Create Build Context
        run: |
          # 这一步是为了确保 Docker 构建上下文的纯净
          mkdir -p build_context
          rsync -av --exclude='.git' --exclude='build_context' ./ build_context/
          
          # 确保 frontend/dist 也就位
          # 此时 build_context 目录包含了构建所需的所有源码和前端资源

      - name: Generate Dockerfile
        run: |
          cat > Dockerfile <<EOF
          # 1. 使用 Debian 10 基础镜像
          FROM debian:buster

          # 2. 修复源 (Archive + Backports)
          RUN echo "deb http://archive.debian.org/debian buster main" > /etc/apt/sources.list && \
              echo "deb http://archive.debian.org/debian-security buster/updates main" >> /etc/apt/sources.list && \
              echo "deb http://archive.debian.org/debian buster-backports main" >> /etc/apt/sources.list && \
              echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until

          # 3. 安装系统依赖
          # 注意：这里我们安装 Go 1.21.13 (最稳定版) 和 WebKit
          RUN apt-get update && \
              apt-get install -y -t buster-backports libwebkit2gtk-4.0-dev || apt-get install -y libwebkit2gtk-4.0-dev && \
              apt-get install -y wget curl git build-essential pkg-config \
              libgtk-3-dev libayatana-appindicator3-dev \
              librsvg2-dev file desktop-file-utils fuse libfuse2 zip && \
              wget https://go.dev/dl/go1.21.13.linux-arm64.tar.gz && \
              tar -C /usr/local -xzf go1.21.13.linux-arm64.tar.gz

          ENV PATH="/usr/local/go/bin:\$PATH"
          ENV CGO_ENABLED=1

          # 4. 预装 Wails (利用 Docker 缓存层)
          RUN go install github.com/wailsapp/wails/v2/cmd/wails@v2.8.2

          # 5. 复制源码到容器内部 (关键步骤：不使用挂载)
          WORKDIR /app
          COPY build_context/ .

          # 6. 修正 go.mod (如果需要) 并编译
          # 强制降级 Wails 依赖以匹配 CLI 工具，防止拉取新版代码
          RUN sed -i 's/github.com\/wailsapp\/wails\/v2 v2.11.0/github.com\/wailsapp\/wails\/v2 v2.8.2/g' go.mod && \
              go mod edit -dropreplace github.com/wailsapp/wails/v2 && \
              go mod tidy && \
              /root/go/bin/wails build -m -s -trimpath -skipbindings -tags webkit2_40 -o GUI.for.SingBox

          # 7. 打包 AppImage (在容器内完成)
          RUN wget -O linuxdeploy https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage && \
              chmod +x linuxdeploy && \
              ./linuxdeploy --appimage-extract && \
              mv squashfs-root linuxdeploy-root && \
              mkdir -p AppDir && \
              cp build/bin/GUI.for.SingBox AppDir/ && \
              (cp build/appicon.png AppDir/appicon.png || touch AppDir/appicon.png) && \
              echo "[Desktop Entry]\nName=GUI.for.SingBox\nExec=GUI.for.SingBox\nIcon=appicon\nType=Application\nCategories=Utility;" > AppDir/gui-for-singbox.desktop && \
              ./linuxdeploy-root/usr/bin/linuxdeploy --appdir AppDir \
                -e build/bin/GUI.for.SingBox \
                -i AppDir/appicon.png \
                -d AppDir/gui-for-singbox.desktop \
                --output appimage && \
              mv *.AppImage /output.AppImage
          EOF

      - name: Build Docker Image & Extract Artifact
        run: |
          # 1. 构建镜像 (所有编译步骤都在这里发生)
          docker build -t builder-image -f Dockerfile .
          
          # 2. 创建临时容器
          docker create --name temp-container builder-image
          
          # 3. 从容器中复制出最终产物
          docker cp temp-container:/output.AppImage ./GUI.for.SingBox-Debian10-ARM64.AppImage
          
          # 4. 清理
          docker rm temp-container

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: GUI-SingBox-Debian10-ARM64
          path: ./*.AppImage